
<!DOCTYPE html>
<html lang="ar" dir="rtl" translate="no">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="google" content="notranslate" />
    <meta name="theme-color" content="#2C3340" />
    <title>Boyoticom PM Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 900: '#2C3340', 800: '#1e232e', 50: '#f0f9ff' },
              accent: { 400: '#E6BC76', 500: '#CE9B52', 600: '#b0823e' },
              crm: { 500: '#6366f1', 600: '#4f46e5' },
              pm: { 500: '#0d9488', 600: '#0f766e', 50: '#f0fdfa' },
              pri: { urgent: '#ef4444', high: '#f97316', medium: '#3b82f6', low: '#64748b' }
            },
            fontFamily: { sans: ['Cairo', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>

    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #2C3340; }
      .date-en { font-family: sans-serif; direction: ltr; display: inline-block; }
      .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2C3340; width: 24px; height: 24px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .kanban-col::-webkit-scrollbar { width: 4px; }
      .kanban-col::-webkit-scrollbar-track { background: transparent; }
      .kanban-col::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="notranslate">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyAOMnl9ikDMngZZH-eSa3ldqtDCh6qsy_U",
          authDomain: "boyoticom-15c4b.firebaseapp.com",
          databaseURL: "https://boyoticom-15c4b-default-rtdb.firebaseio.com",
          projectId: "boyoticom-15c4b",
          storageBucket: "boyoticom-15c4b.firebasestorage.app",
          messagingSenderId: "433583401372",
          appId: "1:433583401372:web:2d483367ad0e0184a10059"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const { useState, useEffect, useMemo, useRef, Component } = window.React;
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = Recharts;

        // --- SHARED UTILS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };
        const safeStr = (val) => (val === null || val === undefined) ? '' : String(val);
        const safeArr = (val) => Array.isArray(val) ? val : [];
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
        const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-GB');
        const Logo = ({ size = 40 }) => {
            const [imgError, setImgError] = useState(false);
            if (imgError) { return (<div className="bg-brand-900 rounded-xl flex items-center justify-center text-accent-500" style={{ width: size, height: size }}><Icon name="box" size={size * 0.6} /></div>); }
            return (<img src="/logo.png" alt="شعار" className="object-contain" style={{ width: size, height: size }} onError={() => setImgError(true)} />);
        };

        const PRIORITIES = {
            urgent: { label: 'عاجل جداً', color: 'bg-red-100 text-red-700 border-red-200', icon: 'alert-triangle' },
            high: { label: 'مرتفع', color: 'bg-orange-100 text-orange-700 border-orange-200', icon: 'arrow-up-circle' },
            medium: { label: 'متوسط', color: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'minus-circle' },
            low: { label: 'منخفض', color: 'bg-gray-100 text-gray-700 border-gray-200', icon: 'arrow-down-circle' }
        };

        // --- COMPONENTS ---

        // 1. Task Card (Updated)
        const TaskCard = ({ task, users, projects, onEdit }) => {
            const project = projects.find(p => p.id === task.projectId);
            const assignees = safeArr(task.assignedTo).map(id => users.find(u => u.id === id) || { name: id, id });
            const dateDue = task.dateDue || null;
            const isOverdue = dateDue && new Date(dateDue) < new Date() && task.status !== 'done';
            
            const subtasks = safeArr(task.subtasks);
            const completedSubtasks = subtasks.filter(s => s.done).length;
            const progress = subtasks.length > 0 ? Math.round((completedSubtasks / subtasks.length) * 100) : 0;
            const priority = PRIORITIES[task.priority] || PRIORITIES.medium;

            return (
                <div className={`bg-white p-4 rounded-xl shadow-sm border hover:shadow-lg transition group relative cursor-pointer ${isOverdue ? 'border-r-4 border-r-red-500' : ''}`} onClick={() => onEdit(task)}>
                    <div className="flex justify-between items-start mb-2">
                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1 ${priority.color}`}>
                            {priority.label}
                        </span>
                        <button onClick={(e) => { e.stopPropagation(); onEdit(task); }} className="text-gray-400 hover:text-pm-600 p-1 rounded-full hover:bg-gray-50 transition"><Icon name="pencil" size={14}/></button>
                    </div>

                    <div className="font-bold text-brand-900 mb-1 leading-snug">{task.title}</div>
                    
                    {project && (<div className="text-xs text-gray-500 mb-3 bg-gray-50 inline-block px-2 py-0.5 rounded-lg border border-gray-100">{project.name}</div>)}
                    
                    {/* Subtasks Progress */}
                    {subtasks.length > 0 && (
                        <div className="mb-3">
                            <div className="flex justify-between text-[10px] text-gray-400 mb-1">
                                <span>المهام الفرعية</span>
                                <span>{completedSubtasks}/{subtasks.length}</span>
                            </div>
                            <div className="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${progress === 100 ? 'bg-green-500' : 'bg-pm-500'}`} style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mt-3 pt-3 border-t border-gray-50">
                        <div className="flex -space-x-2 space-x-reverse overflow-hidden">
                            {assignees.slice(0, 3).map((u, i) => (
                                <div key={i} title={u.name} className="inline-block h-6 w-6 rounded-full ring-2 ring-white bg-gray-200 flex items-center justify-center text-[9px] font-bold text-gray-600">
                                    {u.name.charAt(0)}
                                </div>
                            ))}
                            {assignees.length > 3 && <div className="inline-block h-6 w-6 rounded-full ring-2 ring-white bg-gray-100 flex items-center justify-center text-[9px] font-bold text-gray-500">+{assignees.length - 3}</div>}
                            {assignees.length === 0 && <span className="text-xs text-gray-400">غير مسند</span>}
                        </div>
                        
                        {dateDue && (
                            <div className={`flex items-center gap-1 text-[11px] date-en font-bold ${isOverdue ? 'text-red-500 bg-red-50 px-2 py-0.5 rounded-full' : 'text-gray-400'}`} title="تاريخ الإنجاز">
                                <Icon name="calendar" size={12}/> {formatDate(dateDue)}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 2. Task Modal (Updated with Subtasks & Priority)
        const TaskModal = ({ isOpen, onClose, task, onSave, users, projects, currentUser }) => {
            const initialTaskData = { title: '', projectId: '', description: '', driveLink: '', dateDue: '', assignedTo: [], status: 'todo', priority: 'medium', subtasks: [], notes: [], history: [] };
            const [d, setD] = useState(initialTaskData); 
            const [newNote, setNewNote] = useState(''); 
            const [newSubtask, setNewSubtask] = useState('');
            const [activeTab, setActiveTab] = useState('details'); 
            const notesEndRef = useRef(null);
            
            const pmUsers = useMemo(() => users.filter(u => u.permissions?.pm_access || u.role === 'admin'), [users]);
            
            useEffect(() => { 
                if (isOpen) { 
                    if (task) { 
                        setD({ 
                            ...task, 
                            priority: task.priority || 'medium',
                            subtasks: task.subtasks ? Object.values(task.subtasks) : [],
                            notes: task.notes ? Object.values(task.notes) : [], 
                            history: task.history ? Object.values(task.history) : [] 
                        }); 
                    } else { setD(initialTaskData); } 
                    setActiveTab('details'); 
                } 
            }, [isOpen, task]);
            
            useEffect(() => { notesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [d.notes]);
            
            const handleToggleAssignee = (userId) => { const currentAssignees = safeArr(d.assignedTo); setD(prev => ({ ...prev, assignedTo: currentAssignees.includes(userId) ? currentAssignees.filter(id => id !== userId) : [...currentAssignees, userId] })); };
            
            // Subtasks Logic
            const addSubtask = () => {
                if(!newSubtask.trim()) return;
                const newItem = { id: Date.now(), text: newSubtask, done: false };
                setD(prev => ({ ...prev, subtasks: [...safeArr(prev.subtasks), newItem] }));
                setNewSubtask('');
            };
            const toggleSubtask = (id) => {
                setD(prev => ({ ...prev, subtasks: safeArr(prev.subtasks).map(s => s.id === id ? { ...s, done: !s.done } : s) }));
            };
            const deleteSubtask = (id) => {
                 setD(prev => ({ ...prev, subtasks: safeArr(prev.subtasks).filter(s => s.id !== id) }));
            };

            const handleAddNote = () => { if (!newNote.trim()) return; const noteData = { text: newNote, date: new Date().toISOString(), author: currentUser.name }; const logData = { action: 'إضافة ملاحظة', user: currentUser.name, date: new Date().toISOString() }; setD(prev => ({ ...prev, notes: [...safeArr(prev.notes), noteData], history: [...safeArr(prev.history), logData] })); if (task?.id) { push(ref(db, `tasks/${task.id}/notes`), noteData); push(ref(db, `tasks/${task.id}/history`), logData); } setNewNote(''); };
            
            const handleSaveInternal = () => { 
                if (!d.title || !d.projectId || safeArr(d.assignedTo).length === 0) { return alert('الرجاء إدخال اسم المهمة واختيار المشروع والمسند إليهم.'); } 
                const isNew = !task?.id; 
                let logAction = isNew ? 'إنشاء مهمة جديدة' : 'تحديث بيانات المهمة'; 
                if (!isNew && (d.status !== task.status)) { logAction = `تغيير حالة المهمة إلى ${d.status === 'todo' ? 'قيد الانتظار' : d.status === 'progress' ? 'جاري التنفيذ' : 'مكتملة'}`; } 
                const logData = { action: logAction, user: currentUser.name, date: new Date().toISOString() }; 
                const updatedHistory = [...safeArr(d.history), logData]; 
                const savePayload = { 
                    title: d.title, projectId: d.projectId, description: d.description || '', 
                    driveLink: d.driveLink || '', dateDue: d.dateDue || '', 
                    assignedTo: safeArr(d.assignedTo), status: d.status, priority: d.priority,
                    subtasks: d.subtasks,
                    dateCreated: task?.dateCreated || new Date().toISOString(), createdBy: task?.createdBy || currentUser.name, 
                    notes: d.notes, history: updatedHistory 
                }; 
                onSave(savePayload, task?.id); 
            };
            
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-4xl rounded-2xl p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
                        <div className="flex justify-between items-center border-b pb-3 mb-4"><h3 className="font-black text-xl text-brand-900">{task ? 'تعديل المهمة' : 'إنشاء مهمة جديدة'}</h3><button onClick={onClose} className="text-gray-500 hover:text-gray-700"><Icon name="x"/></button></div>
                        <div className="flex gap-4 mb-4 border-b">
                            <button onClick={() => setActiveTab('details')} className={`font-bold pb-2 transition ${activeTab === 'details' ? 'text-pm-600 border-b-2 border-pm-600' : 'text-gray-500'}`}><Icon name="clipboard-check" size={18} className="inline-block ml-2"/> التفاصيل</button>
                            <button onClick={() => setActiveTab('subtasks')} className={`font-bold pb-2 transition ${activeTab === 'subtasks' ? 'text-pm-600 border-b-2 border-pm-600' : 'text-gray-500'}`}><Icon name="list-checks" size={18} className="inline-block ml-2"/> المهام الفرعية ({safeArr(d.subtasks).filter(s=>!s.done).length})</button>
                            <button onClick={() => setActiveTab('notes')} className={`font-bold pb-2 transition ${activeTab === 'notes' ? 'text-pm-600 border-b-2 border-pm-600' : 'text-gray-500'}`}><Icon name="message-circle" size={18} className="inline-block ml-2"/> الملاحظات ({safeArr(d.notes).length})</button>
                            <button onClick={() => setActiveTab('history')} className={`font-bold pb-2 transition ${activeTab === 'history' ? 'text-pm-600 border-b-2 border-pm-600' : 'text-gray-500'}`}><Icon name="history" size={18} className="inline-block ml-2"/> السجل</button>
                        </div>
                        <div className="min-h-[350px] max-h-[70vh] overflow-y-auto p-2">
                            {activeTab === 'details' && (
                                <div className="space-y-4">
                                    <div className="flex gap-2 items-center">
                                        <div className="flex-1"><input className="w-full text-2xl font-bold border-b p-2 focus:outline-none" placeholder="عنوان المهمة" value={d.title} onChange={e => setD({...d, title: e.target.value})} /></div>
                                        <select className={`border rounded-lg p-2 text-sm font-bold ${PRIORITIES[d.priority].color}`} value={d.priority} onChange={e=>setD({...d, priority: e.target.value})}>
                                            {Object.entries(PRIORITIES).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-xl">
                                        <div><label className="text-xs font-bold block mb-1 text-gray-500">المشروع</label><select className="w-full border rounded-lg p-2 text-sm bg-gray-50" value={d.projectId} onChange={e => setD({...d, projectId: e.target.value})}><option value="">اختر المشروع</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                                        <div><label className="text-xs font-bold block mb-1 text-gray-500">تاريخ الإنجاز المطلوب</label><input type="date" className="w-full border rounded-lg p-2 text-sm bg-gray-50 date-en" value={d.dateDue || ''} onChange={e => setD({...d, dateDue: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold block mb-1 text-gray-500">حالة المهمة</label><select className="w-full border rounded-lg p-2 text-sm font-bold" value={d.status} onChange={e => setD({...d, status: e.target.value})} ><option value="todo">قيد الانتظار</option><option value="progress">جاري التنفيذ</option><option value="done">مكتملة</option></select></div>
                                    </div>
                                    <div><label className="text-xs font-bold block mb-1 text-gray-500">وصف المهمة</label><textarea className="w-full border rounded-lg p-3 h-24 resize-none bg-gray-50" placeholder="وصف تفصيلي للمهمة..." value={d.description} onChange={e => setD({...d, description: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold block mb-1 text-gray-500">رابط (جوجل درايف أو غيره)</label><input type="url" className="w-full border rounded-lg p-2 text-sm bg-gray-50 date-en" placeholder="https://drive.google.com/..." value={d.driveLink} onChange={e => setD({...d, driveLink: e.target.value})} />{d.driveLink && <a href={d.driveLink} target="_blank" className="text-xs text-blue-500 underline mt-1 block">فتح الرابط <Icon name="external-link" size={12} className="inline mr-1"/></a>}</div>
                                    <div className="border p-4 rounded-xl"><label className="text-sm font-bold block mb-2 text-brand-900">المسند إليهم (يمكن اختيار أكثر من شخص)</label><div className="flex flex-wrap gap-2">{pmUsers.map(u => (<button key={u.id} onClick={() => handleToggleAssignee(u.id)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${safeArr(d.assignedTo).includes(u.id) ? 'bg-pm-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{u.name}</button>))}</div></div>
                                </div>
                            )}
                            {activeTab === 'subtasks' && (
                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <input className="flex-1 border rounded-xl p-3 text-sm" placeholder="أضف مهمة فرعية..." value={newSubtask} onChange={e=>setNewSubtask(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addSubtask()} />
                                        <button onClick={addSubtask} className="bg-gray-100 text-gray-600 p-3 rounded-xl hover:bg-gray-200"><Icon name="plus" size={20}/></button>
                                    </div>
                                    <div className="space-y-2">
                                        {safeArr(d.subtasks).map(s => (
                                            <div key={s.id} className="flex items-center gap-3 p-3 border rounded-xl hover:bg-gray-50 group">
                                                <input type="checkbox" checked={s.done} onChange={()=>toggleSubtask(s.id)} className="w-5 h-5 accent-pm-600 rounded cursor-pointer" />
                                                <span className={`flex-1 text-sm ${s.done ? 'line-through text-gray-400' : 'text-gray-800'}`}>{s.text}</span>
                                                <button onClick={()=>deleteSubtask(s.id)} className="text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 transition"><Icon name="trash-2" size={16}/></button>
                                            </div>
                                        ))}
                                        {safeArr(d.subtasks).length === 0 && <div className="text-center text-gray-400 py-10">لا توجد مهام فرعية</div>}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'notes' && (<div className="flex flex-col h-full"><div className="flex-1 bg-white border rounded-xl p-4 mb-4 overflow-y-auto max-h-[60vh] space-y-3 shadow-inner">{safeArr(d.notes).length === 0 && <div className="text-center text-gray-400 text-sm mt-10">لا توجد ملاحظات بعد.</div>}{safeArr(d.notes).map((n, i) => (<div key={i} className={`flex ${n.author === currentUser.name ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-xl shadow-md ${n.author === currentUser.name ? 'bg-pm-600 text-white rounded-bl-lg' : 'bg-gray-100 text-gray-800 rounded-br-lg'}`}><p className="font-bold text-xs mb-1">{n.author === currentUser.name ? 'أنت' : n.author}</p><p className="text-sm break-words">{n.text}</p><span className={`text-[10px] block mt-1 ${n.author === currentUser.name ? 'text-gray-200' : 'text-gray-400'} text-left date-en`}>{formatTime(n.date)}</span></div></div>))}<div ref={notesEndRef} /></div><div className="flex gap-2"><input className="flex-1 border rounded-xl p-3 text-sm focus:ring-1 focus:ring-pm-600 outline-none" placeholder="اكتب ملاحظة جديدة..." value={newNote} onChange={e => setNewNote(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAddNote()} /><button onClick={handleAddNote} className="bg-pm-600 hover:bg-pm-700 text-white p-3 rounded-xl"><Icon name="send" size={20}/></button></div></div>)}
                            {activeTab === 'history' && (<div className="bg-white border rounded-xl p-4 shadow-inner"><div className="text-xs space-y-2 max-h-[60vh] overflow-y-auto">{safeArr(d.history).slice().reverse().map((h, i) => (<div key={i} className="flex justify-between items-start border-b pb-2 last:border-0 last:pb-0"><span className="font-bold text-gray-700 w-3/5">{h.action}</span><div className="text-gray-500 text-left w-2/5"><div className='text-[11px]'>{h.user}</div><div className="date-en text-[10px] text-gray-400">{new Date(h.date).toLocaleDateString('en-GB')} <span className='mr-1'>{new Date(h.date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span></div></div></div>))}{safeArr(d.history).length === 0 && <div className="text-center text-gray-400 text-sm mt-10">لا يوجد سجل أحداث لهذه المهمة.</div>}</div></div>)}
                        </div>
                        <div className="mt-6 pt-4 border-t flex gap-3"><button onClick={onClose} className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200">إلغاء</button><button onClick={handleSaveInternal} className="flex-1 bg-pm-600 text-white py-3 rounded-xl font-bold hover:bg-pm-700 shadow-lg">حفظ المهمة</button></div>
                    </div>
                </div>
            );
        };

        // 3. PM Dashboard (Updated with Charts)
        const PMDashboard = ({ projects, tasks, users }) => {
            const statusData = [
                { name: 'انتظار', value: tasks.filter(t=>t.status==='todo').length, fill: '#9ca3af' },
                { name: 'جاري', value: tasks.filter(t=>t.status==='progress').length, fill: '#3b82f6' },
                { name: 'مكتمل', value: tasks.filter(t=>t.status==='done').length, fill: '#22c55e' }
            ];
            
            const tasksByUser = users.filter(u=>u.id!=='admin').map(u => ({
                name: u.name.split(' ')[0], // First name only
                count: tasks.filter(t => safeArr(t.assignedTo).includes(u.id) && t.status !== 'done').length
            })).filter(u => u.count > 0);

            const overdueCount = tasks.filter(t => t.dateDue && new Date(t.dateDue) < new Date() && t.status !== 'done').length;
            const urgentCount = tasks.filter(t => t.priority === 'urgent' && t.status !== 'done').length;

            return (
                <div className="space-y-6">
                    {/* Key Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border flex flex-col justify-between relative overflow-hidden">
                            <div className="text-gray-500 text-sm font-bold z-10">إجمالي المشاريع</div>
                            <div className="text-3xl font-black text-pm-600 z-10">{projects.length}</div>
                            <Icon name="briefcase" size={60} className="absolute -left-4 -bottom-4 text-pm-50 opacity-50"/>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border flex flex-col justify-between">
                            <div className="text-gray-500 text-sm font-bold">مهام قيد التنفيذ</div>
                            <div className="text-3xl font-black text-blue-600">{tasks.filter(t=>t.status==='progress').length}</div>
                        </div>
                         <div className="bg-white p-6 rounded-2xl shadow-sm border border-red-100 flex flex-col justify-between">
                            <div className="text-gray-500 text-sm font-bold flex items-center gap-2"><Icon name="alert-circle" size={16} className="text-red-500"/> مهام متأخرة</div>
                            <div className="text-3xl font-black text-red-600">{overdueCount}</div>
                        </div>
                         <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-100 flex flex-col justify-between">
                            <div className="text-gray-500 text-sm font-bold flex items-center gap-2"><Icon name="flame" size={16} className="text-orange-500"/> عاجل جداً</div>
                            <div className="text-3xl font-black text-orange-600">{urgentCount}</div>
                        </div>
                    </div>
                    
                    {/* Charts */}
                    {window.Recharts && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                <h3 className="font-bold mb-4 text-sm text-gray-700">توزيع حالة المهام</h3>
                                <div className="h-64" dir="ltr">
                                    <ResponsiveContainer>
                                        <PieChart>
                                            <Pie data={statusData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                                {statusData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.fill} />)}
                                            </Pie>
                                            <RechartsTooltip />
                                            <Legend />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                <h3 className="font-bold mb-4 text-sm text-gray-700">ضغط العمل (مهام نشطة لكل موظف)</h3>
                                <div className="h-64" dir="ltr">
                                    <ResponsiveContainer>
                                        <BarChart data={tasksByUser}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" />
                                            <YAxis />
                                            <RechartsTooltip cursor={{fill: '#f3f4f6'}} />
                                            <Bar dataKey="count" fill="#0d9488" radius={[4, 4, 0, 0]} barSize={40} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PMApp = ({ user, users, projects, tasks }) => {
            const [page, setPage] = useState('dashboard');
            const [modalOpen, setModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [newProjectName, setNewProjectName] = useState(''); 
            
            // Filters
            const [filterProject, setFilterProject] = useState('');
            const [filterUser, setFilterUser] = useState('');
            const [filterPriority, setFilterPriority] = useState('');

            // Filter Logic
            const filteredTasks = tasks.filter(t => {
                const matchProject = filterProject ? t.projectId === filterProject : true;
                const matchUser = filterUser ? safeArr(t.assignedTo).includes(filterUser) : true;
                const matchPriority = filterPriority ? t.priority === filterPriority : true;
                return matchProject && matchUser && matchPriority;
            });

            const getTasksByStatus = (status) => filteredTasks.filter(t => t.status === status);
            const handleAddProject = () => { if (!newProjectName.trim()) return; push(ref(db, 'projects'), { name: newProjectName, createdBy: user.name, dateCreated: new Date().toISOString(), status: 'active' }); setNewProjectName(''); };
            const handleSaveTask = (taskData, taskId) => { const { notes, history, ...payload } = taskData; if (taskId) { update(ref(db, `tasks/${taskId}`), payload); } else { push(ref(db, 'tasks'), { ...payload, notes: notes, history: history }); } setModalOpen(false); setEditingTask(null); };
            const openEditModal = (task) => { setEditingTask(task); setModalOpen(true); };
            const openAddModal = (initialStatus = 'todo') => { setEditingTask({ status: initialStatus }); setModalOpen(true); };

            return (
                <div className="flex min-h-screen bg-slate-50">
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                    <aside className={`fixed inset-y-0 right-0 z-50 w-64 bg-white border-l transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:h-screen ${sidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="p-6 flex justify-between items-center gap-2 font-black text-xl text-brand-900 border-b"><div className="flex items-center gap-2"><Logo size={32} /> بيوتكم</div><button onClick={() => setSidebarOpen(false)} className="md:hidden text-gray-500"><Icon name="x" /></button></div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>{setPage('dashboard');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='dashboard'?'bg-pm-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="layout-dashboard"/> لوحة التحكم</button>
                            <button onClick={()=>{setPage('tasks');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='tasks'?'bg-pm-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="kanban-square"/> المهام (Kanban)</button>
                            <button onClick={()=>{setPage('projects');setSidebarOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='projects'?'bg-pm-600 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="briefcase"/> المشاريع</button>
                        </nav>
                        <div className="p-4 border-t"><button onClick={() => window.location.href='index.html'} className="w-full bg-gray-100 text-gray-600 p-2 rounded-lg font-bold flex items-center justify-center gap-2"><Icon name="grid" size={16}/> تبديل التطبيق</button></div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-30"><div className="flex items-center gap-2"><button onClick={()=>setSidebarOpen(true)} className="md:hidden text-gray-600 p-1"><Icon name="menu" size={24}/></button><div className="font-bold text-xl text-brand-900">نظام إدارة المشاريع Pro</div></div><div className="flex items-center gap-2"><div className="text-sm font-bold">{user.name}</div><div className="w-8 h-8 bg-pm-600 rounded-full text-white flex items-center justify-center font-bold">{user.name[0]}</div></div></header>
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-[1400px] mx-auto flex flex-col min-h-full">
                                <div className="flex-1">
                                    {page === 'dashboard' && <PMDashboard projects={projects} tasks={tasks} users={users} />}
                                    
                                    {page === 'projects' && (<div className="space-y-6"><div className="bg-white p-6 rounded-2xl shadow-sm border"><h3 className="font-bold mb-4 text-lg">إضافة مشروع جديد</h3><div className="flex gap-2"><input className="flex-1 border rounded-xl p-3 outline-none focus:border-pm-600" placeholder="اسم المشروع..." value={newProjectName} onChange={e=>setNewProjectName(e.target.value)} /><button onClick={handleAddProject} className="bg-pm-600 text-white px-6 rounded-xl font-bold hover:bg-pm-700">إضافة</button></div></div><div className="bg-white rounded-2xl shadow-sm border overflow-hidden"><table className="w-full text-right"><thead className="bg-gray-50 text-brand-900 font-bold"><tr><th className="p-4">اسم المشروع</th><th className="p-4">تاريخ الإنشاء</th><th className="p-4">المنشئ</th><th className="p-4">الحالة</th><th className="p-4">المهام</th></tr></thead><tbody className="divide-y">{projects.map(p => (<tr key={p.id} className="hover:bg-gray-50"><td className="p-4 font-bold">{p.name}</td><td className="p-4 text-sm date-en">{formatDate(p.dateCreated)}</td><td className="p-4 text-sm">{p.createdBy}</td><td className="p-4"><span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">نشط</span></td><td className="p-4 font-bold text-pm-600">{tasks.filter(t=>t.projectId===p.id).length}</td></tr>))}{projects.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">لم يتم إضافة مشاريع بعد</td></tr>}</tbody></table></div></div>)}
                                    
                                    {page === 'tasks' && (
                                        <div className="h-full flex flex-col">
                                            {/* Filters Bar */}
                                            <div className="bg-white p-4 rounded-xl shadow-sm border mb-4 flex flex-wrap gap-4 items-center">
                                                <button onClick={() => openAddModal('todo')} className="bg-pm-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-pm-700 flex items-center gap-2 shadow-sm text-sm"><Icon name="plus" size={18}/> <span>مهمة جديدة</span></button>
                                                <div className="h-8 w-px bg-gray-200 hidden md:block"></div>
                                                <select className="bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none focus:border-pm-500" value={filterProject} onChange={e=>setFilterProject(e.target.value)}><option value="">كل المشاريع</option>{projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select>
                                                <select className="bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none focus:border-pm-500" value={filterUser} onChange={e=>setFilterUser(e.target.value)}><option value="">كل الموظفين</option>{users.filter(u=>u.id!=='admin').map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select>
                                                <select className="bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none focus:border-pm-500" value={filterPriority} onChange={e=>setFilterPriority(e.target.value)}><option value="">كل الأولويات</option><option value="urgent">عاجل جداً</option><option value="high">مرتفع</option><option value="medium">متوسط</option><option value="low">منخفض</option></select>
                                                {(filterProject || filterUser || filterPriority) && <button onClick={()=>{setFilterProject('');setFilterUser('');setFilterPriority('')}} className="text-red-500 text-xs font-bold">مسح الفلاتر</button>}
                                                <div className="mr-auto text-gray-400 text-xs font-bold">{filteredTasks.length} مهمة</div>
                                            </div>

                                            {/* Kanban Board */}
                                            <div className="flex-1 overflow-x-auto">
                                                <div className="flex gap-4 min-w-[1000px] h-full pb-4">
                                                    {/* Todo Column */}
                                                    <div className="flex-1 bg-gray-100 rounded-xl flex flex-col kanban-col shadow-inner">
                                                        <div className="p-4 font-black text-gray-600 flex justify-between items-center border-b border-gray-200">
                                                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-gray-400"></div> قيد الانتظار</div>
                                                            <span className="bg-white px-2 py-0.5 rounded-md text-xs border shadow-sm">{getTasksByStatus('todo').length}</span>
                                                        </div>
                                                        <div className="p-3 space-y-3 overflow-y-auto flex-1">
                                                            {getTasksByStatus('todo').map(t => (<TaskCard key={t.id} task={t} users={users} projects={projects} onEdit={openEditModal} />))}
                                                            {getTasksByStatus('todo').length === 0 && <div className="text-center text-gray-400 text-xs py-10">لا توجد مهام</div>}
                                                        </div>
                                                    </div>

                                                    {/* Progress Column */}
                                                    <div className="flex-1 bg-blue-50 rounded-xl flex flex-col kanban-col shadow-inner border border-blue-100">
                                                        <div className="p-4 font-black text-blue-700 flex justify-between items-center border-b border-blue-200">
                                                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500 animate-pulse"></div> جاري التنفيذ</div>
                                                            <span className="bg-white px-2 py-0.5 rounded-md text-xs border shadow-sm">{getTasksByStatus('progress').length}</span>
                                                        </div>
                                                        <div className="p-3 space-y-3 overflow-y-auto flex-1">
                                                            {getTasksByStatus('progress').map(t => (<TaskCard key={t.id} task={t} users={users} projects={projects} onEdit={openEditModal} />))}
                                                            {getTasksByStatus('progress').length === 0 && <div className="text-center text-blue-300 text-xs py-10">لا توجد مهام جارية</div>}
                                                        </div>
                                                    </div>

                                                    {/* Done Column */}
                                                    <div className="flex-1 bg-green-50 rounded-xl flex flex-col kanban-col shadow-inner border border-green-100">
                                                        <div className="p-4 font-black text-green-700 flex justify-between items-center border-b border-green-200">
                                                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-green-500"></div> مكتملة</div>
                                                            <span className="bg-white px-2 py-0.5 rounded-md text-xs border shadow-sm">{getTasksByStatus('done').length}</span>
                                                        </div>
                                                        <div className="p-3 space-y-3 overflow-y-auto flex-1">
                                                            {getTasksByStatus('done').map(t => (<TaskCard key={t.id} task={t} users={users} projects={projects} onEdit={openEditModal} />))}
                                                            {getTasksByStatus('done').length === 0 && <div className="text-center text-green-300 text-xs py-10">لا توجد مهام مكتملة</div>}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                    {modalOpen && ( <TaskModal isOpen={modalOpen} onClose={() => setModalOpen(false)} task={editingTask} onSave={handleSaveTask} users={users} projects={projects} currentUser={user} /> )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [dbUser, setDbUser] = useState(null); 
            const [projects, setProjects] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { 
                const unsub = onAuthStateChanged(auth, u => { 
                    if (u) { 
                        setUser(u); 
                        onValue(ref(db, 'users'), s => { 
                            const data = s.val() || {}; 
                            const list = Object.keys(data).map(k => ({ id: k, ...data[k] })); 
                            setUsers(list); 
                            const profile = list.find(x => x.email.toLowerCase() === u.email.toLowerCase()); 
                            if (u.email.toLowerCase() === 'asleh@boyoticom.com') { 
                                setDbUser({ ...profile, id: u.uid, role: 'admin', name: 'Ali Saleh', email: u.email }); 
                            } else { 
                                setDbUser(profile ? { ...profile, id: u.uid } : { id: u.uid, email: u.email, role: 'employee', name: 'مستخدم جديد' }); 
                            }
                        }); 
                        onValue(ref(db, 'projects'), s => setProjects(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : []));
                        onValue(ref(db, 'tasks'), s => setTasks(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : []));
                    } else { 
                        window.location.href = 'index.html';
                    } 
                    setLoading(false); 
                }); 
                return () => unsub(); 
            }, []);

            if (loading || !dbUser) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;

            return <PMApp user={dbUser} users={users} projects={projects} tasks={tasks} />;
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
