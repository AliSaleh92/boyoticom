<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Boyoticom Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 900: '#2C3340', 800: '#1e232e', 50: '#f0f9ff' },
              accent: { 400: '#E6BC76', 500: '#CE9B52', 600: '#b0823e' },
              crm: { 500: '#6366f1', 600: '#4f46e5' }
            },
            fontFamily: { sans: ['Cairo', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Ù„Ù„Ø®Ø±Ø§Ø¦Ø·) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons & Charts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #2C3340; }
      .date-en { font-family: sans-serif; direction: ltr; display: inline-block; }
      .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2C3340; width: 24px; height: 24px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .leaflet-container { width: 100%; height: 100%; z-index: 1; border-radius: 0.75rem; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
      
      /* Animation for Portal Cards */
      .portal-card { transition: all 0.3s ease; }
      .portal-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAOMnl9ikDMngZZH-eSa3ldqtDCh6qsy_U",
          authDomain: "boyoticom-15c4b.firebaseapp.com",
          databaseURL: "https://boyoticom-15c4b-default-rtdb.firebaseio.com",
          projectId: "boyoticom-15c4b",
          storageBucket: "boyoticom-15c4b.firebasestorage.app",
          messagingSenderId: "433583401372",
          appId: "1:433583401372:web:2d483367ad0e0184a10059"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const { useState, useEffect, useMemo, useRef, Component } = window.React;
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = Recharts;

        // --- UTILS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };
        const safeStr = (val) => (val === null || val === undefined) ? '' : String(val);
        const safeArr = (val) => Array.isArray(val) ? val : [];
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
        const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-GB');

        // --- SHARED COMPONENTS ---
        const Logo = ({ size = 40 }) => (
            <div className="bg-brand-900 rounded-xl flex items-center justify-center text-accent-500" style={{ width: size, height: size }}>
                <Icon name="box" size={size * 0.6} />
            </div>
        );

        // --- 1. LOGIN COMPONENT ---
        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { setError('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); setLoading(false); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-[#f8fafc] p-4">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md text-center">
                        <div className="mx-auto flex items-center justify-center mb-6"><Logo size={80} /></div>
                        <h1 className="text-3xl font-black text-brand-900 mb-2">Ø¨ÙŠÙˆØªÙƒÙ… ERP</h1>
                        <p className="text-gray-500 mb-8">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</p>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm font-bold">{error}</div>}
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input className="w-full p-4 border rounded-xl bg-gray-50 text-right date-en outline-none focus:border-brand-900" type="email" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input className="w-full p-4 border rounded-xl bg-gray-50 text-right date-en outline-none focus:border-brand-900" type="password" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={password} onChange={e=>setPassword(e.target.value)} />
                            <button disabled={loading} className="w-full bg-brand-900 text-white p-4 rounded-xl font-bold hover:bg-brand-800 transition shadow-lg disabled:opacity-70">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- 2. PORTAL (THE CARDS PAGE) ---
        const Portal = ({ user, onSelectApp }) => {
            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6">
                    <div className="max-w-4xl w-full">
                        <div className="flex justify-between items-center mb-10">
                            <div className="flex items-center gap-4">
                                <div className="w-16 h-16 bg-brand-900 rounded-full text-white flex items-center justify-center text-2xl font-bold">{safeStr(user.name).charAt(0)}</div>
                                <div>
                                    <h1 className="text-2xl font-black text-brand-900">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {user.name} ğŸ‘‹</h1>
                                    <p className="text-gray-500">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                                </div>
                            </div>
                            <button onClick={()=>signOut(auth)} className="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold flex items-center gap-2"><Icon name="log-out"/> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {/* CRM Card */}
                            <div onClick={() => onSelectApp('crm')} className="portal-card bg-white p-8 rounded-3xl shadow-lg border-2 border-transparent hover:border-crm-500 cursor-pointer group">
                                <div className="w-20 h-20 bg-crm-500 text-white rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-crm-500/30 group-hover:scale-110 transition-transform">
                                    <Icon name="layout-grid" size={40} />
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</h2>
                                <p className="text-gray-500 leading-relaxed">Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.</p>
                                <div className="mt-6 flex items-center text-crm-600 font-bold">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <Icon name="arrow-left" className="mr-2"/></div>
                            </div>

                            {/* Attendance Card */}
                            <div onClick={() => onSelectApp('attendance')} className="portal-card bg-white p-8 rounded-3xl shadow-lg border-2 border-transparent hover:border-accent-500 cursor-pointer group">
                                <div className="w-20 h-20 bg-accent-500 text-white rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-accent-500/30 group-hover:scale-110 transition-transform">
                                    <Icon name="clock" size={40} />
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>
                                <p className="text-gray-500 leading-relaxed">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØŒ ØªØªØ¨Ø¹ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©ØŒ ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù….</p>
                                <div className="mt-6 flex items-center text-accent-600 font-bold">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… <Icon name="arrow-left" className="mr-2"/></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. ATTENDANCE SYSTEM (CODE FROM PREVIOUS) ---
        const MapZoneEditor = ({ center, radius, onChange }) => {
            const mapRef = useRef(null); const mapObj = useRef(null); const markerObj = useRef(null); const circleObj = useRef(null);
            useEffect(() => {
                if (!mapRef.current) return;
                if (!mapObj.current) {
                    mapObj.current = L.map(mapRef.current).setView([center.lat, center.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapObj.current);
                    const icon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] });
                    markerObj.current = L.marker([center.lat, center.lng], { icon, draggable: true }).addTo(mapObj.current);
                    circleObj.current = L.circle([center.lat, center.lng], { color: '#CE9B52', fillColor: '#CE9B52', fillOpacity: 0.2, radius: radius }).addTo(mapObj.current);
                    const update = (lat, lng) => { markerObj.current.setLatLng([lat, lng]); circleObj.current.setLatLng([lat, lng]); onChange({ lat, lng }, radius); };
                    mapObj.current.on('click', (e) => update(e.latlng.lat, e.latlng.lng));
                    markerObj.current.on('dragend', (e) => { const l = e.target.getLatLng(); update(l.lat, l.lng); });
                }
            }, []);
            useEffect(() => { if(circleObj.current) circleObj.current.setRadius(radius); }, [radius]);
            return <div ref={mapRef} className="w-full h-64 rounded-xl z-0" />;
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const AttendanceApp = ({ user, zones, usersList, logs, onBack }) => {
            const [tab, setTab] = useState(user.role === 'admin' ? 'summary' : 'my_attendance');
            const [showZoneModal, setShowZoneModal] = useState(false);
            const [newZone, setNewZone] = useState({ name: '', startTime: '08:00', endTime: '16:00', lat: 24.7136, lng: 46.6753, radius: 200 });
            const myZone = zones.find(z => z.id === user.zoneId);
            const [status, setStatus] = useState('loading'); const [distance, setDistance] = useState(0); const [processing, setProcessing] = useState(false); const [note, setNote] = useState('');

            const handleAddZone = () => { push(ref(db, 'zones'), newZone); setShowZoneModal(false); alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹'); };
            const exportReport = () => {
                 const data = logs.map(l => {
                    const u = usersList.find(x => x.id === l.uid);
                    return { 'ØªØ§Ø±ÙŠØ®': formatDate(l.timestamp), 'Ø§Ø³Ù…': u?.name, 'Ù†ÙˆØ¹': l.type, 'ÙˆÙ‚Øª': formatTime(l.timestamp), 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': l.note };
                });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Att"); XLSX.writeFile(wb, "Attendance_Report.xlsx");
            };
            useEffect(() => {
                if(tab !== 'my_attendance' || !myZone) return;
                const checkLocation = () => {
                    setStatus('loading');
                    if (!navigator.geolocation) return setStatus('error');
                    navigator.geolocation.getCurrentPosition(
                        (pos) => { const d = calculateDistance(pos.coords.latitude, pos.coords.longitude, myZone.lat, myZone.lng); setDistance(Math.round(d)); setStatus(d <= myZone.radius ? 'in_range' : 'out_range'); },
                        (err) => { console.error(err); setStatus('error'); }, { enableHighAccuracy: true }
                    );
                };
                checkLocation();
            }, [tab, myZone]);
            const handleAttendance = async (type) => {
                if (status !== 'in_range') return;
                setProcessing(true);
                await push(ref(db, 'attendance'), { uid: user.id, type, timestamp: new Date().toISOString(), lat: myZone.lat, lng: myZone.lng, note });
                alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­'); setProcessing(false); setNote('');
            };

            return (
                <div className="min-h-screen bg-slate-50">
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 text-gray-600"><Icon name="arrow-right"/></button>
                            <h1 className="text-xl font-bold text-brand-900 flex items-center gap-2"><Icon name="clock" className="text-accent-500"/> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-sm font-bold text-gray-700">{user.name}</div>
                            <div className="w-8 h-8 rounded-full bg-accent-500 text-white flex items-center justify-center font-bold">{user.name.charAt(0)}</div>
                        </div>
                    </header>
                    <div className="p-6 max-w-5xl mx-auto space-y-6">
                        {user.role === 'admin' && (
                            <div className="flex gap-2 bg-white p-1 rounded-lg border w-fit mx-auto shadow-sm">
                                <button onClick={()=>setTab('summary')} className={`px-4 py-2 rounded-lg text-sm font-bold ${tab==='summary'?'bg-accent-500 text-white':'text-gray-500 hover:bg-gray-50'}`}>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                                <button onClick={()=>setTab('zones')} className={`px-4 py-2 rounded-lg text-sm font-bold ${tab==='zones'?'bg-accent-500 text-white':'text-gray-500 hover:bg-gray-50'}`}>Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
                                <button onClick={()=>setTab('my_attendance')} className={`px-4 py-2 rounded-lg text-sm font-bold ${tab==='my_attendance'?'bg-accent-500 text-white':'text-gray-500 hover:bg-gray-50'}`}>ØªØ³Ø¬ÙŠÙ„ÙŠ</button>
                            </div>
                        )}
                        {tab === 'summary' && user.role === 'admin' && (
                            <div className="bg-white p-6 rounded-2xl shadow border">
                                <div className="flex justify-between mb-4"><h3 className="font-bold">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3><button onClick={exportReport} className="text-sm bg-green-100 text-green-700 px-3 py-1 rounded font-bold">Excel</button></div>
                                <table className="w-full text-sm text-right"><thead className="bg-gray-50"><tr><th className="p-2">Ø§Ù„Ù…ÙˆØ¸Ù</th><th className="p-2">Ø§Ù„Ø­Ø±ÙƒØ©</th><th className="p-2">Ø§Ù„ÙˆÙ‚Øª</th></tr></thead><tbody>{logs.slice().reverse().slice(0,10).map(l => (<tr key={l.id} className="border-b"><td className="p-2">{usersList.find(x=>x.id===l.uid)?.name}</td><td className="p-2">{l.type==='IN'?'Ø¯Ø®ÙˆÙ„':'Ø®Ø±ÙˆØ¬'}</td><td className="p-2 date-en">{formatTime(l.timestamp)}</td></tr>))}</tbody></table>
                            </div>
                        )}
                        {tab === 'zones' && user.role === 'admin' && (
                            <div>
                                <button onClick={()=>setShowZoneModal(true)} className="bg-brand-900 text-white px-4 py-2 rounded-xl mb-4 shadow-lg">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</button>
                                <div className="grid gap-3">{zones.map(z=><div key={z.id} className="bg-white p-4 border rounded-xl shadow-sm flex justify-between items-center"><div><div className="font-bold">{z.name}</div><div className="text-xs text-gray-500 date-en">{z.startTime}-{z.endTime}</div></div><span className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">{z.radius}m</span></div>)}</div>
                            </div>
                        )}
                        {tab === 'my_attendance' && (
                            <div className="bg-white p-8 rounded-2xl shadow-lg text-center max-w-lg mx-auto border-t-4 border-accent-500">
                                 {!myZone ? <div className="text-red-500 bg-red-50 p-4 rounded-xl">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„ Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.</div> : (
                                    <>
                                        <div className="mb-6"><div className="text-sm text-gray-500">Ù…ÙˆÙ‚Ø¹ Ø¹Ù…Ù„Ùƒ: <strong>{myZone.name}</strong></div>{status === 'loading' && <div className="loader mx-auto mt-4"></div>}{status === 'in_range' && <div className="text-green-600 font-bold text-lg mt-4 flex items-center justify-center gap-2 py-2 bg-green-50 rounded-xl"><Icon name="map-pin"/> Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµØ­ÙŠØ­</div>}{status === 'out_range' && <div className="text-red-600 font-bold mt-4 py-2 bg-red-50 rounded-xl">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ ({distance}Ù…)</div>}</div>
                                        <input className="w-full p-3 border rounded-xl mb-4 text-sm bg-gray-50" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." value={note} onChange={e=>setNote(e.target.value)} />
                                        <div className="grid grid-cols-2 gap-4"><button disabled={status!=='in_range'||processing} onClick={()=>handleAttendance('IN')} className="bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button><button disabled={status!=='in_range'||processing} onClick={()=>handleAttendance('OUT')} className="bg-red-600 text-white py-4 rounded-xl font-bold hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
                                    </>
                                 )}
                            </div>
                        )}
                    </div>
                    {showZoneModal && ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white w-full max-w-lg rounded-2xl p-6"><h3 className="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹</h3><input className="w-full border p-2 mb-2 rounded" placeholder="Ø§Ù„Ø§Ø³Ù…" value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} /><MapZoneEditor center={{lat: newZone.lat, lng: newZone.lng}} radius={newZone.radius} onChange={(c, r) => setNewZone({...newZone, lat: c.lat, lng: c.lng, radius: r})} /><div className="flex gap-2 mt-4"><button onClick={handleAddZone} className="flex-1 bg-brand-900 text-white py-2 rounded">Ø­ÙØ¸</button><button onClick={()=>setShowZoneModal(false)} className="flex-1 bg-gray-100 py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button></div></div></div> )}
                </div>
            );
        };

        // --- 4. CRM SYSTEM (ORIGINAL CODE WRAPPED) ---
        const STATUS_LIST = [ { key: 'New', label: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', color: 'bg-blue-50 text-blue-700 border-blue-200' }, { key: 'Contacted1', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 1', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' }, { key: 'Contacted2', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 2', color: 'bg-purple-50 text-purple-700 border-purple-200' }, { key: 'Contacted3', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 3', color: 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200' }, { key: 'Deposit', label: 'Ø¯ÙØ¹ Ø¹Ø±Ø¨ÙˆÙ†', color: 'bg-amber-50 text-amber-700 border-amber-200' }, { key: 'Sold', label: 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹', color: 'bg-emerald-100 text-emerald-800 border-emerald-200' }, { key: 'Cancelled', label: 'Ù…Ù„ØºÙŠ', color: 'bg-red-50 text-red-700 border-red-200' }, ];
        const PROJECT_LIST = ["Ø¨ÙŠÙˆØªÙƒÙ… 10", "Ø¨ÙŠÙˆØªÙƒÙ… 11", "Ø¨ÙŠÙˆØªÙƒÙ… 12", "Ø¨ÙŠÙˆØªÙƒÙ… 13", "Ø¨ÙŠÙˆØªÙƒÙ… 14"];
        const CLIENT_SOURCES = ["Ù…Ø¨Ø§Ø´Ø±", "Ø¹Ù‚Ø§Ø±", "Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø±Ù‚Ù…ÙŠØ©", "ØªÙˆØµÙŠØ© ØµØ¯ÙŠÙ‚"];

        const CRMDashboard = ({ clients }) => {
            const totalClients = clients.length;
            const statusData = STATUS_LIST.map(s => ({ name: s.label, count: clients.filter(c => c.status === s.key).length, key: s.key, color: s.color }));
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-gradient-to-r from-brand-900 to-brand-800 text-white p-6 rounded-2xl shadow-lg flex justify-between items-center"><div><h2 className="text-lg font-bold opacity-80 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><div className="text-4xl font-black">{totalClients}</div></div><div className="bg-white/10 p-4 rounded-full"><Icon name="users" size={32} /></div></div>
                        <div className="bg-white p-6 rounded-2xl shadow-lg border border-amber-100 md:col-span-2 relative"><div className="flex justify-between items-start mb-4"><h3 className="font-bold text-brand-900 flex items-center gap-2"><Icon name="activity" className="text-amber-500"/> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h3></div><div className="h-24 flex items-end gap-2">{statusData.map(s=><div key={s.key} style={{height: `${Math.max(10, (s.count/totalClients)*100)}%`}} className={`flex-1 rounded-t-lg ${s.color.split(' ')[0]} opacity-80`} title={`${s.name}: ${s.count}`}></div>)}</div></div>
                    </div>
                    {/* Add more dashboard widgets here if needed */}
                </div>
            );
        };

        const CRMClientList = ({ clients, users, currentUser, onAdd, onEdit }) => {
            const [search, setSearch] = useState('');
            const filtered = clients.filter(c => (currentUser.role === 'admin' || c.assignedTo === currentUser.name || c.addedBy === currentUser.email) && (safeStr(c.name).includes(search) || safeStr(c.phone).includes(search)));
            return (
                <div className="space-y-4">
                    <div className="flex justify-between"><input className="bg-white border rounded-xl px-4 py-2 w-64 shadow-sm" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." value={search} onChange={e=>setSearch(e.target.value)} /><button onClick={onAdd} className="bg-brand-900 text-white px-4 py-2 rounded-xl font-bold flex gap-2"><Icon name="plus" size={18}/> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="w-full text-right"><thead className="bg-gray-50 font-bold text-brand-900"><tr><th className="p-4">Ø§Ù„Ø§Ø³Ù…</th><th className="p-4">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</th><th className="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th><th className="p-4">Ø§Ù„Ù…ÙˆØ¸Ù</th><th className="p-4"></th></tr></thead><tbody className="divide-y">{filtered.map(c=>(<tr key={c.id} className="hover:bg-gray-50"><td className="p-4 font-bold">{c.name}<div className="text-xs text-gray-500 date-en">{c.phone}</div></td><td className="p-4 text-sm">{safeArr(c.projects).join(', ')}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs border ${STATUS_LIST.find(s=>s.key===c.status)?.color}`}>{STATUS_LIST.find(s=>s.key===c.status)?.label}</span></td><td className="p-4 text-sm">{c.assignedTo}</td><td className="p-4"><button onClick={()=>onEdit(c)} className="text-brand-900"><Icon name="edit" size={18}/></button></td></tr>))}</tbody></table></div>
                </div>
            );
        };

        const ClientModal = ({ isOpen, onClose, client, onSave, users, currentUser }) => {
            const [d, setD] = useState({ name: '', phone: '', projects: [], status: 'New', assignedTo: currentUser.role==='employee'?currentUser.name:'', source: 'Ù…Ø¨Ø§Ø´Ø±', nextFollowUp: '' });
            useEffect(() => { if(client) setD(client); else setD({ name: '', phone: '', projects: [], status: 'New', assignedTo: currentUser.role==='employee'?currentUser.name:'', source: 'Ù…Ø¨Ø§Ø´Ø±', nextFollowUp: '' }); }, [client]);
            const toggleProject = (p) => { const curr = safeArr(d.projects); setD({ ...d, projects: curr.includes(p) ? curr.filter(x=>x!==p) : [...curr, p] }); };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl space-y-4"><h3 className="font-bold text-lg">{client?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„':'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„'}</h3><input className="w-full bg-gray-50 border rounded-lg p-3" placeholder="Ø§Ù„Ø§Ø³Ù…" value={safeStr(d.name)} onChange={e=>setD({...d, name:e.target.value})} /><input className="w-full bg-gray-50 border rounded-lg p-3 date-en text-right" placeholder="05xxxxxxxx" value={safeStr(d.phone)} onChange={e=>setD({...d, phone:e.target.value})} /><div><label className="text-xs font-bold block mb-2">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</label><div className="flex flex-wrap gap-2">{PROJECT_LIST.map(p => (<button key={p} onClick={()=>toggleProject(p)} className={`p-2 rounded text-xs border ${safeArr(d.projects).includes(p)?'bg-brand-900 text-white':'bg-white'}`}>{p}</button>))}</div></div><select className="w-full bg-gray-50 border rounded-lg p-3" value={safeStr(d.status)} onChange={e=>setD({...d, status:e.target.value})}>{STATUS_LIST.map(s=><option key={s.key} value={s.key}>{s.label}</option>)}</select><select className="w-full bg-gray-50 border rounded-lg p-3 disabled:opacity-50" value={safeStr(d.assignedTo)} onChange={e=>setD({...d, assignedTo:e.target.value})} disabled={currentUser.role!=='admin'}><option value="">Ø¨Ø¯ÙˆÙ† Ø¥Ø³Ù†Ø§Ø¯</option>{users.map(u=><option key={u.id} value={u.name}>{u.name}</option>)}</select><div className="flex gap-3"><button onClick={onClose} className="flex-1 bg-gray-100 py-3 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button><button onClick={()=>onSave(d)} className="flex-1 bg-brand-900 text-white py-3 rounded-lg">Ø­ÙØ¸</button></div></div></div>
            );
        };

        const CRMReports = ({ clients, users }) => {
            const reportData = users.map(u => {
                const userClients = clients.filter(c => c.assignedTo === u.name);
                return { id: u.id, name: u.name, total: userClients.length, sold: userClients.filter(c => c.status === 'Sold').length };
            });
            return (
                <div className="bg-white rounded-xl shadow-sm border p-6">
                    <h3 className="font-bold mb-4">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                    <table className="w-full text-right"><thead className="bg-gray-50"><tr><th className="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th><th className="p-3">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</th><th className="p-3 text-green-600">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th></tr></thead><tbody>{reportData.map(r=><tr key={r.id} className="border-b"><td className="p-3 font-bold">{r.name}</td><td className="p-3">{r.total}</td><td className="p-3 text-green-600 font-bold">{r.sold}</td></tr>)}</tbody></table>
                </div>
            )
        };
        const CRMUsers = ({ users, currentUser }) => {
             const [newUser, setNewUser] = useState({ name: '', email: '', uid: '', role: 'employee' });
             const [showAdd, setShowAdd] = useState(false);
             const handleAdd = (e) => { e.preventDefault(); if(!newUser.uid) return alert('UID Ù…Ø·Ù„ÙˆØ¨'); set(ref(db, `users/${newUser.uid}`), newUser); setShowAdd(false); alert('ØªÙ…'); };
             return (
                <div className="space-y-4">
                    <div className="flex justify-between"><h3 className="font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>{currentUser.role==='admin' && <button onClick={()=>setShowAdd(!showAdd)} className="bg-brand-900 text-white px-3 py-1 rounded text-sm">+ Ù…ÙˆØ¸Ù</button>}</div>
                    {showAdd && <form onSubmit={handleAdd} className="bg-white p-4 border rounded-xl grid gap-2"><input placeholder="Ø§Ù„Ø§Ø³Ù…" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})}/><input placeholder="Email" value={newUser.email} onChange={e=>setNewUser({...newUser, email:e.target.value})}/><input placeholder="UID" value={newUser.uid} onChange={e=>setNewUser({...newUser, uid:e.target.value})}/><button className="bg-brand-900 text-white p-2 rounded">Ø­ÙØ¸</button></form>}
                    <div className="grid gap-2">{users.map(u=><div key={u.id} className="bg-white p-3 border rounded flex justify-between"><span>{u.name}</span><span className="text-xs bg-gray-100 p-1 rounded">{u.role}</span></div>)}</div>
                </div>
             );
        };
        const BackupSettings = ({ clients, users }) => ( <div className="bg-white p-6 rounded-xl shadow-sm border"><button onClick={() => { const data = { clients, users, date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = "backup.json"; link.click(); }} className="w-full bg-brand-900 text-white p-3 rounded-lg flex justify-center gap-2"><Icon name="download" /> ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button></div> );

        const CRMApp = ({ user, clients, users, onSaveClient, onBack }) => {
            const [page, setPage] = useState('dashboard');
            const [modalOpen, setModalOpen] = useState(false);
            const [editClient, setEditClient] = useState(null);

            const handleAdd = () => { setEditClient(null); setModalOpen(true); };
            const handleEdit = (c) => { setEditClient(c); setModalOpen(true); };
            const handleSave = (d) => { onSaveClient(d, editClient); setModalOpen(false); };

            return (
                <div className="flex min-h-screen bg-slate-50">
                    <aside className="w-64 bg-white border-l h-screen sticky top-0 flex flex-col z-10">
                        <div className="p-6 flex items-center gap-2 font-black text-xl text-brand-900 border-b">
                            <Logo size={32} /> Ø¨ÙŠÙˆØªÙƒÙ… CRM
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setPage('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='dashboard'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="layout-dashboard"/> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                            <button onClick={()=>setPage('clients')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='clients'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="users"/> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                            {user.role === 'admin' && (
                                <>
                                    <button onClick={()=>setPage('reports')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='reports'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="bar-chart-2"/> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                                    <button onClick={()=>setPage('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='users'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="shield"/> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
                                    <button onClick={()=>setPage('backup')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition ${page==='backup'?'bg-brand-900 text-white':'text-gray-500 hover:bg-gray-50'}`}><Icon name="settings"/> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                                </>
                            )}
                        </nav>
                        <div className="p-4 border-t bg-gray-50">
                            <button onClick={onBack} className="w-full bg-white border border-gray-300 text-gray-700 p-2 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-gray-100 transition"><Icon name="grid" size={16}/> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
                        </div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto">
                        <header className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-bold text-brand-900">{page==='dashboard'?'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…':page==='clients'?'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª':page==='reports'?'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':page==='users'?'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†':'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}</h2>
                            <div className="flex items-center gap-3">
                                <div className="text-sm font-bold text-gray-700">{user.name}</div>
                                <div className="w-10 h-10 rounded-full bg-brand-900 text-white flex items-center justify-center font-bold">{user.name.charAt(0)}</div>
                            </div>
                        </header>
                        <div className="max-w-6xl mx-auto">
                            {page === 'dashboard' && <CRMDashboard clients={clients} />}
                            {page === 'clients' && <CRMClientList clients={clients} users={users} currentUser={user} onAdd={handleAdd} onEdit={handleEdit} />}
                            {page === 'reports' && <CRMReports clients={clients} users={users} />}
                            {page === 'users' && <CRMUsers users={users} currentUser={user} />}
                            {page === 'backup' && <BackupSettings clients={clients} users={users} />}
                        </div>
                    </main>
                    {modalOpen && <ClientModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} client={editClient} onSave={handleSave} users={users} currentUser={user} />}
                </div>
            );
        };

        // --- 5. MAIN ORCHESTRATOR ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [dbUser, setDbUser] = useState(null);
            const [currentApp, setCurrentApp] = useState('portal'); // 'portal', 'crm', 'attendance'
            
            // Shared Data State
            const [clients, setClients] = useState([]);
            const [users, setUsers] = useState([]);
            const [zones, setZones] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, u => {
                    if (u) {
                        setUser(u);
                        // Fetch Users
                        onValue(ref(db, 'users'), s => {
                            const data = s.val() || {};
                            const list = Object.keys(data).map(k => ({ id: k, ...data[k] }));
                            setUsers(list);
                            const profile = list.find(x => x.email.toLowerCase() === u.email.toLowerCase());
                            if (u.email.toLowerCase() === 'asleh@boyoticom.com') {
                                setDbUser({ ...profile, id: u.uid, role: 'admin', name: 'Ali Saleh', email: u.email });
                            } else {
                                setDbUser(profile ? { ...profile, id: u.uid } : { id: u.uid, email: u.email, role: 'employee', name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯' });
                            }
                        });
                        // Fetch All Data needed for both apps
                        onValue(ref(db, 'clients'), s => setClients(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})).reverse() : []));
                        onValue(ref(db, 'zones'), s => setZones(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : []));
                        onValue(ref(db, 'attendance'), s => setLogs(s.val() ? Object.keys(s.val()).map(k => ({id:k, ...s.val()[k]})) : []));
                    } else {
                        setUser(null); setDbUser(null);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleSaveClient = (data, existing) => {
                const payload = { ...data, assignedTo: safeStr(data.assignedTo), projects: safeArr(data.projects) };
                if (existing) update(ref(db, `clients/${existing.id}`), payload);
                else push(ref(db, 'clients'), { ...payload, dateAdded: new Date().toISOString(), addedBy: dbUser.email });
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;
            if (!user) return <Login />;
            if (!dbUser) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;

            // --- ROUTING ---
            if (currentApp === 'crm') {
                return <CRMApp user={dbUser} clients={clients} users={users} onSaveClient={handleSaveClient} onBack={() => setCurrentApp('portal')} />;
            }
            if (currentApp === 'attendance') {
                return <AttendanceApp user={dbUser} zones={zones} usersList={users} logs={logs} onBack={() => setCurrentApp('portal')} />;
            }
            
            // Default: Portal
            return <Portal user={dbUser} onSelectApp={setCurrentApp} />;
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
