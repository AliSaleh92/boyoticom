<!DOCTYPE html>
<html lang="ar" dir="rtl" translate="no">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="google" content="notranslate" />
    <title>Boyoticom Portal | Ø¨ÙŠÙˆØªÙƒÙ…</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 50: '#f0f9ff', 100: '#e0f2fe', 800: '#1e232e', 900: '#2C3340', 950: '#0f172a' },
              accent: { 50: '#fffbf0', 100: '#fef3c7', 400: '#E6BC76', 500: '#CE9B52', 600: '#b0823e', 700: '#92662d' },
              crm: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
              success: { 50: '#f0fdf4', 500: '#22c55e', 700: '#15803d' },
              danger: { 50: '#fef2f2', 500: '#ef4444', 700: '#b91c1c' }
            },
            fontFamily: { sans: ['Cairo', 'sans-serif'] },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-in-out',
              'slide-up': 'slideUp 0.4s ease-out',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-font-smoothing: antialiased; }
      .date-en { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: ltr; display: inline-block; }
      .leaflet-container { width: 100%; height: 100%; z-index: 1; border-radius: 1rem; }
      
      /* Scrollbar Styling */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      
      .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
      .input-field { transition: all 0.2s; }
      .input-field:focus { box-shadow: 0 0 0 4px rgba(206, 155, 82, 0.15); border-color: #CE9B52; }
    </style>
</head>
<body class="notranslate overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE CONFIGURATION (Reused from v1) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAOMnl9ikDMngZZH-eSa3ldqtDCh6qsy_U",
          authDomain: "boyoticom-15c4b.firebaseapp.com",
          databaseURL: "https://boyoticom-15c4b-default-rtdb.firebaseio.com",
          projectId: "boyoticom-15c4b",
          storageBucket: "boyoticom-15c4b.firebasestorage.app",
          messagingSenderId: "433583401372",
          appId: "1:433583401372:web:2d483367ad0e0184a10059"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const { useState, useEffect, useMemo, useRef, createContext, useContext } = window.React;
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = Recharts;

        // --- CONTEXT & TOAST SYSTEM ---
        const ToastContext = createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 3000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex flex-col gap-2 z-[9999] pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`pointer-events-auto min-w-[300px] shadow-2xl rounded-xl p-4 flex items-center gap-3 animate-slide-up ${
                                t.type === 'success' ? 'bg-brand-900 text-white' : 
                                t.type === 'error' ? 'bg-danger-500 text-white' : 
                                'bg-white text-gray-800 border border-gray-100'
                            }`}>
                                <div className={`p-1 rounded-full ${t.type === 'success' ? 'bg-white/20' : 'bg-black/10'}`}>
                                    <Icon name={t.type === 'success' ? 'check' : t.type === 'error' ? 'alert-triangle' : 'info'} size={16} />
                                </div>
                                <span className="font-bold text-sm">{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => useContext(ToastContext);

        // --- UTILS & COMPONENTS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Logo = ({ size = 40, light = false }) => (
            <div className={`flex items-center justify-center font-black tracking-tighter ${light ? 'text-white' : 'text-brand-900'}`} style={{ fontSize: size * 0.6 }}>
                <div className="relative">
                    <Icon name="box" size={size} className={light ? "text-accent-400" : "text-brand-900"} />
                    <div className="absolute -bottom-1 -right-1 bg-accent-500 rounded-full w-3 h-3 border-2 border-white"></div>
                </div>
            </div>
        );

        const safeStr = (val) => (val === null || val === undefined) ? '' : String(val);
        const safeArr = (val) => Array.isArray(val) ? val : [];
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });

        // --- CONSTANTS ---
        const STATUS_LIST = [ 
            { key: 'New', label: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', color: 'bg-blue-100 text-blue-700 border-blue-200' }, 
            { key: 'Contacted1', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 1', color: 'bg-indigo-100 text-indigo-700 border-indigo-200' }, 
            { key: 'Contacted2', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 2', color: 'bg-purple-100 text-purple-700 border-purple-200' }, 
            { key: 'Contacted3', label: 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ 3', color: 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' }, 
            { key: 'Deposit', label: 'Ø¯ÙØ¹ Ø¹Ø±Ø¨ÙˆÙ†', color: 'bg-amber-100 text-amber-700 border-amber-200' }, 
            { key: 'Sold', label: 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹', color: 'bg-emerald-100 text-emerald-800 border-emerald-200' }, 
            { key: 'Cancelled', label: 'Ù…Ù„ØºÙŠ', color: 'bg-red-100 text-red-700 border-red-200' }, 
        ];
        const PROJECT_LIST = ["Ø¨ÙŠÙˆØªÙƒÙ… 10", "Ø¨ÙŠÙˆØªÙƒÙ… 11", "Ø¨ÙŠÙˆØªÙƒÙ… 12", "Ø¨ÙŠÙˆØªÙƒÙ… 13", "Ø¨ÙŠÙˆØªÙƒÙ… 14"];
        const CLIENT_SOURCES = ["Ù…Ø¨Ø§Ø´Ø±", "Ø¹Ù‚Ø§Ø±", "Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø±Ù‚Ù…ÙŠØ©", "ØªÙˆØµÙŠØ© ØµØ¯ÙŠÙ‚"];

        // --- 1. LOGIN ---
        const Login = () => {
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false);
            const { addToast } = useToast();

            const handleLogin = async (e) => { 
                e.preventDefault(); 
                setLoading(true); 
                try { 
                    await signInWithEmailAndPassword(auth, email, password); 
                    addToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (err) { 
                    addToast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error'); 
                    setLoading(false); 
                } 
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-brand-900 p-4 relative overflow-hidden">
                    {/* Abstract Background Shapes */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                        <div className="absolute -top-20 -left-20 w-96 h-96 bg-accent-500 rounded-full blur-[120px] opacity-20"></div>
                        <div className="absolute bottom-0 right-0 w-[500px] h-[500px] bg-brand-800 rounded-full blur-[100px] opacity-50"></div>
                    </div>

                    <div className="bg-white/10 backdrop-blur-xl border border-white/10 p-8 md:p-12 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center relative z-10 animate-slide-up">
                        <div className="mx-auto flex items-center justify-center mb-8 bg-white w-24 h-24 rounded-3xl shadow-lg transform rotate-3 hover:rotate-0 transition-all duration-500">
                            <Logo size={60} />
                        </div>
                        <h1 className="text-4xl font-black text-white mb-2">Ø¨ÙŠÙˆØªÙƒÙ… ERP</h1>
                        <p className="text-gray-300 mb-8 font-medium">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</p>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div className="relative group">
                                <div className="absolute top-1/2 right-4 -translate-y-1/2 text-gray-400 group-focus-within:text-accent-400 transition-colors"><Icon name="mail" size={20}/></div>
                                <input className="w-full p-4 pr-12 border-2 border-transparent bg-white/10 rounded-2xl text-white placeholder-gray-400 outline-none focus:bg-white/20 focus:border-accent-500/50 transition-all date-en text-right" 
                                    type="email" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value={email} onChange={e=>setEmail(e.target.value)} />
                            </div>
                            <div className="relative group">
                                <div className="absolute top-1/2 right-4 -translate-y-1/2 text-gray-400 group-focus-within:text-accent-400 transition-colors"><Icon name="lock" size={20}/></div>
                                <input className="w-full p-4 pr-12 border-2 border-transparent bg-white/10 rounded-2xl text-white placeholder-gray-400 outline-none focus:bg-white/20 focus:border-accent-500/50 transition-all date-en text-right" 
                                    type="password" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={password} onChange={e=>setPassword(e.target.value)} />
                            </div>
                            <button disabled={loading} className="w-full bg-accent-500 hover:bg-accent-400 text-white p-4 rounded-2xl font-bold transition-all shadow-lg hover:shadow-accent-500/20 disabled:opacity-70 disabled:cursor-not-allowed mt-4 transform active:scale-95">
                                {loading ? <span className="flex items-center justify-center gap-2"><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...</span> : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}
                            </button>
                        </form>
                    </div>
                    <div className="absolute bottom-6 text-white/20 text-xs font-mono">v2.0 Enhanced</div>
                </div>
            );
        };

        // --- 2. SHARED COMPONENTS ---
        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-md' }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-brand-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-fade-in">
                    <div className={`bg-white w-full ${maxWidth} rounded-3xl shadow-2xl max-h-[90vh] overflow-y-auto animate-slide-up flex flex-col`}>
                        <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h3 className="font-black text-xl text-brand-900">{title}</h3>
                            <button onClick={onClose} className="bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="p-6 flex-1">{children}</div>
                    </div>
                </div>
            );
        };

        const PageHeader = ({ title, subtitle, action }) => (
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div>
                    <h1 className="text-3xl font-black text-brand-900">{title}</h1>
                    {subtitle && <p className="text-gray-500 mt-1">{subtitle}</p>}
                </div>
                {action}
            </div>
        );

        // --- 3. PORTAL ---
        const PortalCard = ({ title, desc, icon, colorClass, borderClass, onClick, locked }) => (
            <div onClick={!locked ? onClick : undefined} 
                className={`relative overflow-hidden bg-white p-8 rounded-[2.5rem] shadow-xl border-2 transition-all duration-300 group ${locked ? 'opacity-60 grayscale cursor-not-allowed border-dashed border-gray-200' : `cursor-pointer border-transparent hover:${borderClass} hover:-translate-y-2 hover:shadow-2xl`}`}>
                {!locked && <div className={`absolute top-0 right-0 w-32 h-32 ${colorClass} opacity-5 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-150`}></div>}
                <div className={`w-20 h-20 ${locked ? 'bg-gray-200' : colorClass} text-white rounded-3xl flex items-center justify-center mb-6 shadow-lg group-hover:scale-110 transition-transform duration-300`}>
                    <Icon name={locked ? 'lock' : icon} size={36} />
                </div>
                <h2 className="text-2xl font-black text-gray-800 mb-2">{title}</h2>
                <p className="text-gray-500 leading-relaxed mb-8 h-12">{desc}</p>
                <div className={`flex items-center font-bold text-lg ${locked ? 'text-gray-400' : 'text-brand-900'} group-hover:gap-3 transition-all`}>
                    <span>{locked ? 'ØºÙŠØ± Ù…ØµØ±Ø­' : 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…'}</span>
                    {!locked && <Icon name="arrow-left" className="mr-2" size={18}/>}
                </div>
            </div>
        );

        const Portal = ({ user, users, onSelectApp }) => {
            const isAdmin = user.role === 'admin';
            const p = user.permissions || {};

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col p-6 overflow-y-auto">
                    <header className="flex justify-between items-center max-w-6xl mx-auto w-full mb-12 py-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-brand-900 p-2 rounded-xl text-white"><Logo size={24} light /></div>
                            <span className="font-bold text-xl text-brand-900 hidden md:block">Ø¨ÙŠÙˆØªÙƒÙ…</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-left hidden md:block">
                                <div className="font-bold text-sm text-brand-900">{user.name}</div>
                                <div className="text-xs text-gray-500">{isAdmin ? 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : 'Ù…ÙˆØ¸Ù'}</div>
                            </div>
                            <button onClick={()=>signOut(auth)} className="bg-white border border-gray-200 p-3 rounded-xl text-danger-500 hover:bg-red-50 transition"><Icon name="log-out" size={20}/></button>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col items-center justify-center max-w-5xl mx-auto w-full animate-fade-in pb-20">
                        <div className="text-center mb-16 space-y-4">
                            <h1 className="text-4xl md:text-5xl font-black text-brand-900">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ğŸ‘‹</h1>
                            <p className="text-xl text-gray-500">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„ÙŠÙˆÙ…</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                            <PortalCard 
                                title="Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)" 
                                desc="Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„ØµÙÙ‚Ø§ØªØŒ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ¹ÙŠØ© ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯."
                                icon="layout-grid"
                                colorClass="bg-crm-600"
                                borderClass="border-crm-500"
                                locked={!isAdmin && !p.crm_access}
                                onClick={() => onSelectApp('crm')}
                            />
                            <PortalCard 
                                title="Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø°ÙƒÙŠ" 
                                desc="Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙÙˆØ±ÙŠØ©."
                                icon="map-pin"
                                colorClass="bg-accent-500"
                                borderClass="border-accent-500"
                                locked={!isAdmin && !p.att_access}
                                onClick={() => onSelectApp('attendance')}
                            />
                        </div>

                        {isAdmin && (
                            <button onClick={() => onSelectApp('users')} className="mt-12 bg-white px-8 py-4 rounded-2xl shadow-sm border border-gray-200 font-bold text-brand-900 flex items-center gap-3 hover:bg-gray-50 transition">
                                <Icon name="users-round" className="text-brand-900"/>
                                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                            </button>
                        )}
                    </main>
                </div>
            );
        };

        // --- 4. CRM SYSTEM ---
        const CRMStatCard = ({ title, count, icon, color }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between group hover:shadow-md transition">
                <div>
                    <div className="text-gray-500 text-sm font-bold mb-1">{title}</div>
                    <div className="text-3xl font-black text-brand-900">{count}</div>
                </div>
                <div className={`w-12 h-12 rounded-2xl ${color} flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition`}>
                    <Icon name={icon} size={24}/>
                </div>
            </div>
        );

        const CRMClientList = ({ clients, users, currentUser, onAdd, onEdit }) => {
            const [search, setSearch] = useState('');
            const { addToast } = useToast();
            
            // Filter logic
            const filtered = clients.filter(c => {
                 if(currentUser.role !== 'admin' && currentUser.permissions?.crm_role === 'employee' && c.assignedTo !== currentUser.name) return false;
                 return safeStr(c.name).toLowerCase().includes(search.toLowerCase()) || safeStr(c.phone).includes(search);
            });

            const exportExcel = () => {
                const data = filtered.map(c => ({ 'Ø§Ù„Ø§Ø³Ù…': c.name, 'Ø¬ÙˆØ§Ù„': c.phone, 'Ø§Ù„Ø­Ø§Ù„Ø©': c.status }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Clients");
                XLSX.writeFile(wb, "clients.xlsx");
                addToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„', 'success');
            };

            return (
                <div className="space-y-6 animate-slide-up">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div className="relative w-full md:w-96">
                            <div className="absolute top-1/2 right-3 -translate-y-1/2 text-gray-400"><Icon name="search" size={18}/></div>
                            <input className="w-full bg-gray-50 border-none rounded-xl py-3 pr-10 pl-4 outline-none focus:ring-2 focus:ring-crm-500/20 transition" 
                                placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." value={search} onChange={e=>setSearch(e.target.value)} />
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <button onClick={exportExcel} className="flex-1 md:flex-none bg-emerald-50 text-emerald-600 px-6 py-3 rounded-xl font-bold hover:bg-emerald-100 transition flex items-center justify-center gap-2">
                                <Icon name="sheet" size={18}/> <span className="hidden md:inline">ØªØµØ¯ÙŠØ±</span>
                            </button>
                            <button onClick={onAdd} className="flex-1 md:flex-none bg-brand-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-brand-800 transition shadow-lg shadow-brand-900/20 flex items-center justify-center gap-2">
                                <Icon name="plus" size={18}/> <span>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</span>
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-right">
                                <thead className="bg-gray-50/50 border-b border-gray-100 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    <tr>
                                        <th className="p-5">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th className="p-5">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th className="p-5">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                                        <th className="p-5">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                        <th className="p-5">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                                        <th className="p-5 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-50">
                                    {filtered.map(c => {
                                        const statusObj = STATUS_LIST.find(s=>s.key===c.status) || STATUS_LIST[0];
                                        return (
                                            <tr key={c.id} className="hover:bg-brand-50/30 transition group">
                                                <td className="p-5">
                                                    <div className="font-bold text-brand-900">{c.name}</div>
                                                    <div className="text-xs text-gray-500 date-en font-mono mt-1">{c.phone}</div>
                                                </td>
                                                <td className="p-5">
                                                    <span className={`px-3 py-1.5 rounded-full text-xs font-bold border ${statusObj.color}`}>
                                                        {statusObj.label}
                                                    </span>
                                                </td>
                                                <td className="p-5 text-sm font-medium text-gray-600">{safeArr(c.projects).join(', ')}</td>
                                                <td className="p-5">
                                                    {c.assignedTo ? (
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold">{c.assignedTo[0]}</div>
                                                            <span className="text-sm">{c.assignedTo}</span>
                                                        </div>
                                                    ) : <span className="text-xs text-gray-400">ØºÙŠØ± Ù…Ø³Ù†Ø¯</span>}
                                                </td>
                                                <td className="p-5 text-xs text-gray-500 date-en">{c.dateAdded?.slice(0,10)}</td>
                                                <td className="p-5">
                                                    <div className="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={()=>onEdit(c)} className="p-2 bg-white border rounded-lg text-brand-900 hover:bg-brand-900 hover:text-white transition shadow-sm"><Icon name="pencil" size={16}/></button>
                                                        <a href={`https://wa.me/966${safeStr(c.phone).substring(1)}`} target="_blank" className="p-2 bg-white border rounded-lg text-emerald-600 hover:bg-emerald-500 hover:text-white transition shadow-sm"><Icon name="message-circle" size={16}/></a>
                                                    </div>
                                                </td>
                                            </tr>
                                        )
                                    })}
                                    {filtered.length === 0 && (
                                        <tr><td colSpan="6" className="p-12 text-center text-gray-400 flex flex-col items-center"><Icon name="inbox" size={48} className="mb-4 opacity-20"/>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const CRMApp = ({ user, clients, users, onBack }) => {
            const [view, setView] = useState('dashboard');
            const [modalOpen, setModalOpen] = useState(false);
            const [editClient, setEditClient] = useState(null);
            const { addToast } = useToast();

            const handleSave = (clientData) => {
                const payload = { ...clientData, lastUpdated: new Date().toISOString() };
                if(clientData.id) {
                    update(ref(db, `clients/${clientData.id}`), payload);
                    addToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'success');
                } else {
                    push(ref(db, 'clients'), { ...payload, dateAdded: new Date().toISOString(), addedBy: user.email });
                    addToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', 'success');
                }
                setModalOpen(false);
            };

            // Calculate stats
            const stats = useMemo(() => {
                const myClients = user.role === 'admin' ? clients : clients.filter(c => c.assignedTo === user.name);
                return {
                    total: myClients.length,
                    new: myClients.filter(c => c.status === 'New').length,
                    sold: myClients.filter(c => c.status === 'Sold').length,
                    calls: myClients.filter(c => c.status.includes('Contacted')).length
                };
            }, [clients, user]);

            return (
                <div className="flex min-h-screen bg-slate-50 overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-20 lg:w-72 bg-brand-900 flex-shrink-0 flex flex-col justify-between py-6 transition-all duration-300">
                        <div className="flex flex-col items-center lg:items-start px-0 lg:px-6">
                            <div className="mb-10 flex items-center gap-3 text-white">
                                <div className="bg-accent-500 p-2 rounded-xl"><Logo size={24} light /></div>
                                <span className="font-black text-xl hidden lg:block">Ø¨ÙŠÙˆØªÙƒÙ… CRM</span>
                            </div>
                            <nav className="w-full space-y-2 px-2 lg:px-0">
                                {[
                                    { id: 'dashboard', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', icon: 'layout-dashboard' },
                                    { id: 'clients', label: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', icon: 'users' },
                                ].map(item => (
                                    <button key={item.id} onClick={()=>setView(item.id)} 
                                        className={`w-full p-3 rounded-xl flex items-center justify-center lg:justify-start gap-4 transition-all ${view === item.id ? 'bg-accent-500 text-white shadow-lg shadow-accent-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                        <Icon name={item.icon} size={22} />
                                        <span className="font-bold hidden lg:block">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>
                        <div className="px-2 lg:px-6">
                            <button onClick={onBack} className="w-full p-3 rounded-xl border border-white/10 text-gray-400 hover:bg-white/5 hover:text-white transition flex items-center justify-center lg:justify-start gap-4">
                                <Icon name="arrow-right" size={20} />
                                <span className="font-bold hidden lg:block">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto p-4 lg:p-8">
                        {view === 'dashboard' && (
                            <div className="max-w-6xl mx-auto animate-fade-in space-y-8">
                                <PageHeader title="Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" subtitle={`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name}ØŒ Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¦Ùƒ Ø§Ù„ÙŠÙˆÙ…`} />
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <CRMStatCard title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" count={stats.total} icon="users" color="bg-brand-900" />
                                    <CRMStatCard title="Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯" count={stats.new} icon="user-plus" color="bg-blue-500" />
                                    <CRMStatCard title="Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø¬Ø§Ø±ÙŠØ©" count={stats.calls} icon="phone-call" color="bg-amber-500" />
                                    <CRMStatCard title="ØµÙÙ‚Ø§Øª Ù†Ø§Ø¬Ø­Ø©" count={stats.sold} icon="check-circle" color="bg-emerald-500" />
                                </div>

                                <div className="grid lg:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-brand-900 mb-6">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                                        <div className="h-64 flex items-center justify-center text-gray-400">
                                            {/* Placeholder for chart */}
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={STATUS_LIST.map(s => ({ name: s.label, val: clients.filter(c=>c.status===s.key).length }))}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="name" hide />
                                                    <YAxis />
                                                    <RechartsTooltip cursor={{fill: '#f1f5f9'}} contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                                                    <Bar dataKey="val" fill="#2C3340" radius={[4,4,0,0]} barSize={40} />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="bg-brand-900 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden">
                                        <div className="relative z-10">
                                            <h3 className="font-bold text-lg mb-2">ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                                            <div className="space-y-3 mt-4">
                                                {clients.slice(0, 3).map(c => (
                                                    <div key={c.id} className="bg-white/10 p-3 rounded-xl flex items-center justify-between">
                                                        <div className="text-sm">{c.name}</div>
                                                        <div className="text-xs text-accent-400 font-mono">{c.phone}</div>
                                                    </div>
                                                ))}
                                                {clients.length === 0 && <div className="text-white/50 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°ÙƒÙŠØ±Ø§Øª</div>}
                                            </div>
                                        </div>
                                        <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-accent-500 rounded-full blur-[60px] opacity-20"></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'clients' && (
                            <div className="max-w-6xl mx-auto">
                                <PageHeader title="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" />
                                <CRMClientList clients={clients} users={users} currentUser={user} 
                                    onAdd={()=>{setEditClient({}); setModalOpen(true)}} 
                                    onEdit={(c)=>{setEditClient(c); setModalOpen(true)}} 
                                />
                            </div>
                        )}
                    </main>

                    {/* Client Modal */}
                    <Modal isOpen={modalOpen} onClose={()=>setModalOpen(false)} title={editClient?.id ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'} maxWidth="max-w-2xl">
                        <ClientForm client={editClient} users={users} onSave={handleSave} onClose={()=>setModalOpen(false)} currentUser={user} />
                    </Modal>
                </div>
            );
        };

        const ClientForm = ({ client, users, onSave, onClose, currentUser }) => {
            const [formData, setFormData] = useState({ name: '', phone: '', status: 'New', assignedTo: currentUser.role==='employee'?currentUser.name:'', projects: [] });
            useEffect(() => { if(client) setFormData({ ...formData, ...client }); }, [client]);

            return (
                <div className="space-y-4">
                    <div className="grid md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <input className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:bg-white focus:border-accent-500 outline-none transition" 
                                value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"/>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:bg-white focus:border-accent-500 outline-none transition date-en text-right" 
                                value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value})} placeholder="05xxxxxxxx"/>
                        </div>
                    </div>
                    
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <div className="flex flex-wrap gap-2">
                            {STATUS_LIST.map(s => (
                                <button key={s.key} onClick={()=>setFormData({...formData, status: s.key})}
                                    className={`px-3 py-2 rounded-lg text-xs font-bold border transition ${formData.status===s.key ? 'bg-brand-900 text-white border-brand-900' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'}`}>
                                    {s.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                            <select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" 
                                value={safeStr(formData.assignedTo)} onChange={e=>setFormData({...formData, assignedTo:e.target.value})}>
                                <option value="">Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù...</option>
                                {users.map(u=><option key={u.id} value={u.name}>{u.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡Ø§</label>
                            <div className="bg-gray-50 border border-gray-200 rounded-xl p-2 max-h-24 overflow-y-auto">
                                {PROJECT_LIST.map(p => (
                                    <label key={p} className="flex items-center gap-2 p-1 cursor-pointer hover:bg-white rounded">
                                        <input type="checkbox" checked={safeArr(formData.projects).includes(p)} 
                                            onChange={e=>{
                                                const newP = e.target.checked ? [...safeArr(formData.projects), p] : safeArr(formData.projects).filter(x=>x!==p);
                                                setFormData({...formData, projects: newP});
                                            }} className="accent-accent-500"/>
                                        <span className="text-xs">{p}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="pt-4 flex gap-3">
                        <button onClick={onClose} className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Ø¥Ù„ØºØ§Ø¡</button>
                        <button onClick={()=>onSave(formData)} className="flex-1 bg-accent-500 text-white py-3 rounded-xl font-bold hover:bg-accent-600 transition shadow-lg shadow-accent-500/20">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>
            );
        };

        // --- 5. ATTENDANCE SYSTEM ---
        const AttendanceApp = ({ user, zones, logs, onBack }) => {
            const [myStatus, setMyStatus] = useState('locating'); // locating, inside, outside
            const [currentZone, setCurrentZone] = useState(null);
            const { addToast } = useToast();

            useEffect(() => {
                const myZone = zones.find(z => safeArr(z.assignedUsers).includes(user.id));
                setCurrentZone(myZone);
                
                if(!myZone) {
                    setMyStatus('no_zone');
                    return;
                }

                if(navigator.geolocation) {
                    const watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, myZone.lat, myZone.lng);
                            setMyStatus(dist <= myZone.radius ? 'inside' : 'outside');
                        },
                        (err) => {
                            console.error(err);
                            setMyStatus('error');
                            addToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS', 'error');
                        }
                    );
                    return () => navigator.geolocation.clearWatch(watchId);
                }
            }, [zones, user]);

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // metres
                const Ï†1 = lat1 * Math.PI/180;
                const Ï†2 = lat2 * Math.PI/180;
                const Î”Ï† = (lat2-lat1) * Math.PI/180;
                const Î”Î» = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            };

            const handleAction = (type) => {
                if(myStatus !== 'inside' && user.role !== 'admin') {
                    addToast('Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„', 'error');
                    return;
                }
                push(ref(db, 'attendance'), { uid: user.id, type, timestamp: new Date().toISOString() });
                addToast(type === 'IN' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± âœ…' : 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù ğŸ‘‹', 'success');
            };

            // Calculate Today's Log
            const todayLog = useMemo(() => {
                const today = new Date().toDateString();
                const myLogs = logs.filter(l => l.uid === user.id && new Date(l.timestamp).toDateString() === today);
                return {
                    in: myLogs.find(l => l.type === 'IN'),
                    out: myLogs.find(l => l.type === 'OUT')
                };
            }, [logs, user]);

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-brand-900 text-white p-4 shadow-lg flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <button onClick={onBack} className="p-2 bg-white/10 rounded-lg hover:bg-white/20"><Icon name="arrow-right" size={20}/></button>
                            <h1 className="font-bold text-lg">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</h1>
                        </div>
                        <div className="text-sm opacity-80">{user.name}</div>
                    </header>

                    <main className="flex-1 p-6 flex flex-col items-center max-w-lg mx-auto w-full gap-6 animate-fade-in">
                        
                        {/* Status Card */}
                        <div className={`w-full p-8 rounded-[2.5rem] shadow-xl text-center transition-all duration-500 border-4 ${
                            myStatus === 'inside' ? 'bg-white border-success-500' : 
                            myStatus === 'outside' ? 'bg-white border-danger-500' : 'bg-gray-100 border-gray-300'
                        }`}>
                            <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center text-4xl mb-4 transition-all ${
                                myStatus === 'inside' ? 'bg-success-50 text-success-700 animate-pulse' : 
                                myStatus === 'outside' ? 'bg-danger-50 text-danger-700' : 'bg-gray-200 text-gray-400'
                            }`}>
                                <Icon name={myStatus === 'inside' ? 'map-pin' : myStatus === 'outside' ? 'map-pin-off' : 'loader-2'} size={40} className={myStatus==='locating'?'animate-spin':''}/>
                            </div>
                            <h2 className="text-2xl font-black text-gray-800 mb-2">
                                {myStatus === 'inside' ? 'Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚' : 
                                 myStatus === 'outside' ? 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚' : 
                                 myStatus === 'locating' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø·Ø§Ù‚ Ù…Ø³Ù†Ø¯'}
                            </h2>
                            <p className="text-gray-500 text-sm">
                                {currentZone ? `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯: ${currentZone.name}` : 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù'}
                            </p>
                        </div>

                        {/* Actions */}
                        <div className="grid grid-cols-2 gap-4 w-full">
                            <button onClick={()=>handleAction('IN')} disabled={todayLog.in} 
                                className="bg-success-500 hover:bg-success-700 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed text-white p-6 rounded-3xl shadow-lg shadow-success-500/30 transition transform active:scale-95 flex flex-col items-center gap-2">
                                <Icon name="log-in" size={32}/>
                                <span className="font-bold text-xl">Ø­Ø¶ÙˆØ±</span>
                                {todayLog.in && <span className="text-xs font-mono opacity-80">{formatTime(todayLog.in.timestamp)}</span>}
                            </button>
                            
                            <button onClick={()=>handleAction('OUT')} disabled={!todayLog.in || todayLog.out} 
                                className="bg-brand-900 hover:bg-brand-800 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed text-white p-6 rounded-3xl shadow-lg shadow-brand-900/30 transition transform active:scale-95 flex flex-col items-center gap-2">
                                <Icon name="log-out" size={32}/>
                                <span className="font-bold text-xl">Ø§Ù†ØµØ±Ø§Ù</span>
                                {todayLog.out && <span className="text-xs font-mono opacity-80">{formatTime(todayLog.out.timestamp)}</span>}
                            </button>
                        </div>

                        {/* Today's Summary */}
                        <div className="w-full bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-brand-900 mb-4 flex items-center gap-2"><Icon name="clock" size={18}/> Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h3>
                            <div className="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                                <div>
                                    <div className="text-xs text-gray-500 mb-1">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
                                    <div className="text-xl font-black text-accent-600 font-mono">
                                        {todayLog.in && todayLog.out ? (
                                            (() => {
                                                const diff = new Date(todayLog.out.timestamp) - new Date(todayLog.in.timestamp);
                                                const hrs = Math.floor(diff / 3600000);
                                                const mins = Math.round((diff % 3600000) / 60000);
                                                return `${hrs}Ø³ ${mins}Ø¯`;
                                            })()
                                        ) : '--:--'}
                                    </div>
                                </div>
                                <div className="h-8 w-px bg-gray-300"></div>
                                <div className="text-left">
                                    <div className="text-xs text-gray-500 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                                    <div className="text-sm font-bold text-gray-800">{todayLog.in ? (todayLog.out ? 'Ù…ÙƒØªÙ…Ù„' : 'ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†') : 'Ù„Ù… ÙŠØ¨Ø¯Ø£'}</div>
                                </div>
                            </div>
                        </div>

                    </main>
                </div>
            );
        };

        // --- 6. USER MANAGER ---
        const UsersApp = ({ users, onBack }) => {
            const [localUsers, setLocalUsers] = useState(users);
            
            // This is a placeholder for the advanced user management from v1
            // keeping it simple for the enhanced index demonstration
            return (
                <div className="min-h-screen bg-slate-50 p-6">
                     <PageHeader title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†" action={
                         <button onClick={onBack} className="bg-white px-4 py-2 rounded-xl shadow font-bold text-gray-600">Ø±Ø¬ÙˆØ¹</button>
                     } />
                     <div className="bg-white rounded-3xl shadow p-6">
                        <div className="grid gap-4">
                            {users.map(u => (
                                <div key={u.id} className="flex justify-between items-center p-4 border rounded-xl hover:bg-gray-50">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-brand-900 text-white rounded-full flex items-center justify-center">{u.name?.[0]}</div>
                                        <div>
                                            <div className="font-bold">{u.name}</div>
                                            <div className="text-xs text-gray-500">{u.email}</div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        {u.permissions?.crm_access && <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">CRM</span>}
                                        {u.permissions?.att_access && <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-bold">Att</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                     </div>
                </div>
            );
        };

        // --- 7. APP ROOT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [dbUser, setDbUser] = useState(null);
            const [appState, setAppState] = useState('loading'); // loading, login, portal, crm, attendance, users
            const [data, setData] = useState({ clients: [], users: [], zones: [], logs: [] });

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, u => {
                    if (u) {
                        setUser(u);
                        // Fetch Profile
                        onValue(ref(db, 'users'), s => {
                            const usersList = s.val() ? Object.keys(s.val()).map(k => ({ id: k, ...s.val()[k] })) : [];
                            let profile = usersList.find(x => x.email.toLowerCase() === u.email.toLowerCase());
                            
                            // Admin Override Logic from V1
                            if (u.email.toLowerCase() === 'asleh@boyoticom.com') {
                                profile = { ...profile, role: 'admin', name: 'Ali Saleh', id: u.uid, email: u.email };
                            } else if (!profile) {
                                profile = { id: u.uid, email: u.email, role: 'employee', name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯' };
                            }
                            
                            setDbUser(profile);
                            setData(prev => ({ ...prev, users: usersList }));
                            if (appState === 'loading' || appState === 'login') setAppState('portal');
                        });

                        // Fetch Data
                        onValue(ref(db, 'clients'), s => setData(prev => ({ ...prev, clients: s.val() ? Object.values(s.val()) : [] })));
                        onValue(ref(db, 'zones'), s => setData(prev => ({ ...prev, zones: s.val() ? Object.values(s.val()) : [] })));
                        onValue(ref(db, 'attendance'), s => setData(prev => ({ ...prev, logs: s.val() ? Object.values(s.val()) : [] })));

                    } else {
                        setUser(null);
                        setDbUser(null);
                        setAppState('login');
                    }
                });
                return () => unsub();
            }, []);

            const Content = () => {
                if (appState === 'loading') return (
                    <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-50">
                        <div className="w-16 h-16 border-4 border-brand-200 border-t-brand-900 rounded-full animate-spin mb-4"></div>
                        <div className="text-gray-400 font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                );
                
                if (appState === 'login') return <Login />;
                if (!dbUser) return null; // Wait for profile

                switch (appState) {
                    case 'crm': return <CRMApp user={dbUser} clients={data.clients} users={data.users} onBack={()=>setAppState('portal')} />;
                    case 'attendance': return <AttendanceApp user={dbUser} zones={data.zones} logs={data.logs} onBack={()=>setAppState('portal')} />;
                    case 'users': return <UsersApp users={data.users} onBack={()=>setAppState('portal')} />;
                    default: return <Portal user={dbUser} users={data.users} onSelectApp={setAppState} />;
                }
            };

            return (
                <ToastProvider>
                    <Content />
                </ToastProvider>
            );
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
